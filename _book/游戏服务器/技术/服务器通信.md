### CS的连接方式

* 用socket建立连接来进行数据交互

  交互过程：

  * Server创建socket，监听特定端口(IP+port)
  * Client创建Socket,连接到Server监听的端口
  * Server接受Client连接，创建socket与之进行通信
  * Client和Server进行数据交互
  * Client和Server断开连接，回收资源

* 一次网页的访问的流程
  * 首先浏览器向DNS服务器请求一个IP信息，就是某个域名比如QQ.com,然后DNS服务器会相应一个IP信息和端口信息（UDP）
  * 接下来就是浏览器建立socket连接（TCP）
  * 接下来客户端向webServer发送http请求，webServer服务器就把数据返回给它了  
    

**案例分析**

**PC上的QQ CS交互**

* 一般情况下

  使用UDP，因为网络比较好，我们可以在应用层上做一些处理，保证我们的数据能够比较可靠的到达对端

* 网络状况差

  使用TCP

* 拉取大文件

  使用TCP，因为TCP本来就是适合处理大数据量

**手机长微信的CS交互**

* 前台运行时

  TCP长连接，不断地跟服务器有一个心跳维持，不断地拉取信息，服务器也会主动给他推送信息

* 后台运行时

  TCP短链接，不间断的去向服务器做一个短连接的发起，这样它才能知道我最近来了什么信息，应该拉取什么信息

* 查看文章时

  HTTP（TCP短连接）
  

**QQ微信对于TCP,UDP选择的原因**

一台物理机能接受UDP18W点击，TCP只有12W，QQ开发的早，早期各种配置很差，没什么钱





### UDP的分包

* 前置条件
  * 假设每个分片丢包概率为10%
  * 每个数据包有三次重发的逻辑
* 问题1：发送一个10K的包成功的概率是多少
* 问题2：发送10个1k的包成功的概率是多少



UDP的MTU(最大传输单元)为1480

答案1：

* 10k = 7个分片

* 单次成功概率为90%^7 = 47.8%

* 最终成功概率为(1-47.8%）^3 = 86%

答案2：

* 10个1k = 10个分片

* 单包成功概率1-10%^3 = 99%
* 最终成功概率99.9%^3 = 99%



结论：不要对单包超过1k，假设我们拉取好友信息，我们可以按照内容划分，先拉取它的QQ号，接下来再拉取昵称，再拉取其他信息  


### 设计CS交互的问题

* Case1:客户端收到的数值总是跟服务器对不上

  原因：可能是字节序问题，有的不同CPU不同OS上，字节序可能不同

  方案：字节序转换，转换成网络字节序

* Case2:服务器下发的小包数据，客户端常常延迟一段时间收到

  原因：nagle算法（小包并不立即发送，先缓存起来，等其它的一些包过来的时候再一起发送，或者等超时再发送）

  方案：禁用nagle算法

* Case3:实时交互中，数据量较大或者网络波动较大，容易发送失败

  原因：网络传输速度较慢，发送缓冲区满

  方案：适当增大缓冲区（一般1M,2M左右）



### 服务器之间常用的连接方式

* TCP

  最为常用

* UDP

  * 非关键数据上报
  * 日志服务

* 非socket通信

  * PIPE
  * SIGNAL
  * SHM
  * MESAGE QUEUE
  * FILE  
    

### 玩家掉线原因诊断

* 玩家网络状况不佳
* 玩家连错了接入服务器
* 服务器网络故障
* 数据同步量太大
* 服务器卡顿

