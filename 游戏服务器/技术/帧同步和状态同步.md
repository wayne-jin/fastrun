# 帧同步和状态同步

### 同步

所谓同步，就是要多个客户端表现效果是一致的，例如我们玩王者荣耀的时候，需要十个玩家的屏幕显示的英雄位置完全相同、技能释放角度、释放时间完全相同，这个就是同步。就好像很多个人一起跳街舞齐舞，每个人的动作都要保持一致。而对于大多数游戏，不仅客户端的表现要一致，而且需要客户端和服务端的数据是一致的。所以，同步是一个网络游戏概念，只有网络游戏才需要同步，而单机游戏是不需要同步的  


### 帧同步和状态同步的区别

最大的区别就是战斗核心逻辑写在哪，状态同步的战斗逻辑在服务端，帧同步的战斗逻辑写在客户端。战斗逻辑是包括技能逻辑、普攻、属性、伤害、移动、AI、检测、碰撞等等的一系列内容，这常常也被视为游戏开发过程中最难的部分。由于核心逻辑必须知道一个场景中的所有实体情况，所以MMO游戏（例如魔兽世界）就必须把战斗逻辑写在服务端，所以MMO游戏必须是状态同步的，因为MMO游戏的客户端承载有限，并不能把整张地图的实体全部展现出来（例如100米以外的NPC和玩家就不显示了），所以客户端没有足够的信息计算全图的人的所有行为。  


具体到客户端和服务端通信上，在状态同步下，客户端更像是一个服务端数据的表现层，举个例子，一个英雄的几乎所有属性（例如血量、攻击、防御、攻速、魔法值等等）都是服务端传给客户端的，而且在属性发生改变的时候，服务端需要实时告诉客户端哪些属性改变了，客户端并不能改变这些属性，而是服务端传来多少属性就显示多少属性（虽然可以改变客户端数值达到表现上的效果，例如无限血量，但是服务端那边的血量属性为0时，一样要死）。再举个例子，一个英雄要释放一个非指向性技能（例如伊泽瑞尔的Q），具体的过程就是，客户端通知服务端“我要释放一个技能”-》服务端通知客户端“在某地以什么方向释放某技能”-》客户端根据这些信息创建一个特效放在某地，然后以某个方向飞行-》服务端根据碰撞检测逻辑判断到某个时刻，这个技能碰到了敌方英雄，通知客户端-》客户端根据服务端信息，删除特效，被打的英雄减血同时播放受击特效。

  而在帧同步下，通信就比较简单了，服务端只转发操作，不做任何逻辑处理。以下图为例：

![img](https://pic1.zhimg.com/80/v2-859c22fc93aee3736307732289283cb4_720w.jpg)

现在同一局里有4个玩家，也就是4个客户端，这时客户端A释放了一个技能x，此时将操作传递给服务端，服务端不做任何判断，直接把A的操作全部分发给ABCD，则ABCD同时让客户端A控制的英雄释放技能x。  

* **流量**

  状态同步比帧同步流量消耗大，例如一个复杂游戏的英雄属性可能有100多条，每次改变都要同步一次属性，这个消耗是巨大的，而帧同步不需要同步属性；例如释放一个技能，服务端需要通知客户端很多条消息（必须是分步的，不然功能做不了），而帧同步就只需要转发一次操作就行了  
  

* **回放&观战**

  帧同步的回放&观战比状态同步好做得多，因为只需要保存每局所有人的操作就好了，而状态同步的回放&观战，需要有一个回放&观战服务器，当一局战斗打响，战斗服务器在给客户端发送消息的同时，还需要把这些消息发给放&观战服务器，回放&观战服务器做储存，如果有其他客户端请求回放或者观战，则回放&观战服务器把储存起来的消息按时间发给客户端    
  

* **安全性**

  状态同步的安全性比帧同步高很多，因为状态同步的所有逻辑和数值都是在服务端的，如果想作弊，就必须攻击服务器，而攻击服务器的难度比更改自己客户端数据的难度高得多，而且更容易被追踪，被追踪到了还会有极高的法律风险。而帧同步因为所有数据全部在客户端，所以解析客户端的数据之后，就可以轻松达到自己想要的效果，例如moba类游戏的全图挂，吃鸡游戏的透视挂，都是没办法防止的，而更改数据达到胜利的作弊方式（例如更改自己的英雄攻击力）可以通过服务器比对同局其他人的战斗结果来预防  
  

* **服务器压力**

  状态同步服务器压力比较大，因为要做更多运算  
  

* **开发效率**

  首先要说，状态同步的游戏占主流，其次就是状态同步开发起来比较难。而帧同步服务器开发难度低，同一套方案可以给很多不同类型的游戏使用，反正都是转发操作；减少了服务端客户端沟通，老实说，没有扯皮的时间，开发效率最起码提高20%，状态同步的方案下，同一个功能至少需要一个客户端和服务端共同完成；PVP和PVE基本用的是同一套代码，做完PVP很容易就可以做单机的PVE  
  

* **断线重连**

  状态同步的断线重连很好做，无非就是把整个场景和人物全部重新生成一遍，各种数值根据服务端提供加到人物身上而已。帧同步的断线重连就比较麻烦了，例如客户端在战场开始的第10秒短线了，第15秒连回来了，就需要服务端把第10秒到第15秒之间5秒内的所有消息一次性发给客户端，然后客户端加速整个游戏的核心逻辑运行速度（例如加速成10倍），直到追上现有进度  
    

* **游戏选择**

  ![img](https://pic3.zhimg.com/80/v2-840bbd4862293450026e386ba79f8d02_720w.jpg)

  对于大部分游戏来说，两种同步方式都可以使用。但相比之下**状态同步适用型更广，特别适合复杂度高，延迟要求高，玩家多的游戏**，例如FPS，MMO等等。**帧同步相对适合小兵很多，玩家少且固定，单局时间短，对打击感公平性要求高，追求一致性的游戏**，例如格斗，运动，RTS，卡牌，MOBA等。

  从技术角度来说，帧同步有一些技术限制，大量玩家战斗，随时进入退出，难以预表现等，而状态同步有更多的优化手段可以更好的降低延迟感。**可以说用帧同步的一定能用状态同步**，但反过来不成立。

  当然帧同步也有自己的优势，**实现成本相对简单开发比较快速（一套逻辑不太需要联调）**，在**玩家较少小兵较多的情况下（**由于只同步事件而非状态，所以网络传输的数据和游戏里的对象数量无关**）服务器性能和带宽开销极低，**甚至可以没有服务器（服务器可以完全不跑战斗逻辑只在需要反挂的时候跑），有点去中心化的意思。也非常适合一些单机游戏改成联网得游戏，非常适合中小公司（之前开发的一个MOBA游戏**只有一个服务器同学**）。

  **我们在选择的时候需要综合考虑游戏类型，未来需求，战斗时长，游戏模式，网络带宽，延迟响应，防作弊，开发成本周期和实力等因素**来选用不同的同步方案，**甚至混合使用**。**没有最好的技术只有最适合的技术**。下面是一些在选择时可以思考的一些参考问题：

  ![img](https://pic1.zhimg.com/80/v2-a31a53f2cb9a8360baadb788e72d1204_720w.jpg)

  

  ## 
